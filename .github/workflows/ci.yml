name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # ===========================================
  # JOB 1: TEST - Lint + Unit Tests + CLI Tests
  # ===========================================
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
        cache: 'pip'
        cache-dependency-path: requirements.txt

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        # Install neural-memory if available (mock mode if not)
        pip install neural-memory || echo "‚ö†Ô∏è neural-memory not available, using mock mode"

    - name: Lint with flake8
      run: |
        echo "üîç Running flake8 linting..."
        flake8 src --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 src --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        flake8 tests --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        echo "‚úÖ Linting passed"

    - name: Run unit tests
      run: |
        echo "üß™ Running pytest..."
        pytest tests/ -v --tb=short --cov=src --cov-report=term-missing
        echo "‚úÖ Unit tests passed"

    - name: Test CLI commands
      run: |
        echo "üñ•Ô∏è Testing CLI commands..."
        
        # Create isolated test directory
        TEST_DIR="/tmp/nocl-test-$$"
        mkdir -p "$TEST_DIR"
        cd "$TEST_DIR"
        
        # Test help
        python3 $GITHUB_WORKSPACE/nocl.py --help
        
        # Test init
        python3 $GITHUB_WORKSPACE/nocl.py init --project ci-test
        
        # Test core commands
        python3 $GITHUB_WORKSPACE/nocl.py --project ci-test decision "CI test decision" --context "Testing CI"
        python3 $GITHUB_WORKSPACE/nocl.py --project ci-test insight "CI test insight"
        python3 $GITHUB_WORKSPACE/nocl.py --project ci-test fact "CI test fact"
        python3 $GITHUB_WORKSPACE/nocl.py --project ci-test context "CI test context" --expires 1
        
        # Test cache
        python3 $GITHUB_WORKSPACE/nocl.py --project ci-test cache test_tool '{"key": "value"}' '{"result": "ok"}' --ttl 1
        
        # Test recall
        python3 $GITHUB_WORKSPACE/nocl.py --project ci-test recall "test query" --confidence 0.5
        
        # Test task
        python3 $GITHUB_WORKSPACE/nocl.py --project ci-test task "Test task" --max-tokens 500
        
        # Test status
        python3 $GITHUB_WORKSPACE/nocl.py --project ci-test status
        
        # Cleanup
        cd /
        rm -rf "$TEST_DIR"
        
        echo "‚úÖ CLI tests passed"

  # ===========================================
  # JOB 2: BUILD - Syntax + Structure Validation
  # ===========================================
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Verify package structure
      run: |
        echo "üì¶ Verifying package structure..."
        
        # Required files
        test -f README.md || { echo "‚ùå README.md not found"; exit 1; }
        test -f requirements.txt || { echo "‚ùå requirements.txt not found"; exit 1; }
        test -f nocl.py || { echo "‚ùå nocl.py not found"; exit 1; }
        test -f pyproject.toml || { echo "‚ùå pyproject.toml not found"; exit 1; }
        
        # Required directories
        test -d src || { echo "‚ùå src/ directory not found"; exit 1; }
        test -d tests || { echo "‚ùå tests/ directory not found"; exit 1; }
        
        # Core modules (if they exist)
        for dir in src/neural_layer src/router src/assembler; do
          if [ -d "$dir" ]; then
            echo "‚úÖ Found $dir"
          fi
        done
        
        echo "‚úÖ Package structure verified"

    - name: Validate Python syntax
      run: |
        echo "üêç Validating Python syntax..."
        
        # Validate main files
        python3 -m py_compile nocl.py || { echo "‚ùå nocl.py syntax error"; exit 1; }
        
        # Validate src files
        find src -name "*.py" -exec python3 -m py_compile {} \; || { echo "‚ùå src/ syntax error"; exit 1; }
        
        # Validate test files
        find tests -name "*.py" -exec python3 -m py_compile {} \; || { echo "‚ùå tests/ syntax error"; exit 1; }
        
        echo "‚úÖ Python syntax validated"

    - name: Verify documentation
      run: |
        echo "üìö Verifying documentation..."
        
        # Check docs directory
        if [ -d docs ]; then
          DOC_COUNT=$(find docs -name "*.md" | wc -l)
          echo "‚úÖ Found $DOC_COUNT documentation files"
        else
          echo "‚ö†Ô∏è docs/ directory not found (optional)"
        fi
        
        # Check README has essential sections
        if grep -q "## Overview" README.md && grep -q "## Installation" README.md; then
          echo "‚úÖ README.md has essential sections"
        else
          echo "‚ö†Ô∏è README.md may be missing essential sections"
        fi
        
        echo "‚úÖ Documentation verified"
